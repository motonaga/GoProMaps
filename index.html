
<!DOCTYPE html>
<html lang="ja">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<title>GoProMap</title>
<style>
html { height: 100%; }
body { 
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
}
.container {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
}
@media (orientation: landscape) {
    .container {
        display: flex;
    }
    #movie { 
        height: 100%;
        width: 50%;
        background-color: #333;
    }
    #map {
        height: 100%;
        width: 50%;
    }
}
@media (orientation: portrait) {
    .container {
        display: block;
    }
    #movie {
       width: 100%;
       height: 50%;
    }
    #map {
        width: 100%;
        height: 50%;
    }
}
</style>
</head>

<body>
    <div class="container">
        <div id="movie">
            <div id="player"></div>
        </div>
        <div id="map"></div>
    </div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
<script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAq_4WtgcJ9z0bB3gYpmoZRrzI3yJCD2mM&callback=initMap&&libraries=geometry&v=weekly"
      async
></script>
<script>
    $( "#movie" ).resizable({
        resize: function(event, ui) { resize(); }
    });

    let tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    let firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    let player;
    const playerHeight = '360';
    const playerWidth = '640';
    let map;
    let marker;
    let latlngs = [];
    let times = [];
    let autoPan = true;
    let controlUI;
    let controlText;
    const autoPanEnabledColor = "rgb(26, 115, 232)";
    const autoPanDisabledColor = "rgb(128, 128, 128)";

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: playerHeight,
            width: playerWidth,
            videoId: '4lUbhRZFFdo',
            playerVars: {
                playsinline: 1,
                autoplay: 1,
                rel: 0
            },
            events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        resize();
        const player = event.target;
        player.mute();
        player.playVideo();
        player.setPlaybackRate(2);
    }
    
    var done = false;
    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING && !done) {
            // setTimeout(stopVideo, 6000);
            // done = true;
        }
    }
    function pauseVideo() {
        player.pauseVideo();
    }
    function stopVideo() {
        player.stopVideo();
    }

    function setAutoPan(pan) {
        autoPan = pan;
        let color = autoPanDisabledColor;
        if (autoPan) color = autoPanEnabledColor;
        // controlText.style.color = color;
        controlUI.style.backgroundColor = color;
        controlUI.style.borderColor = color;
    }

    function PanControl(controlDiv, map) {
        // Set CSS for the control border.
        controlUI = document.createElement("div");
        controlUI.style.backgroundColor = autoPanEnabledColor;
        controlUI.style.border = "2px solid #fff";
        controlUI.style.borderColor = autoPanEnabledColor;
        controlUI.style.borderRadius = "3px";
        controlUI.style.boxShadow = "0 2px 6px rgba(0,0,0,.3)";
        controlUI.style.cursor = "pointer";
        controlUI.style.marginTop = "8px";
        controlUI.style.marginBottom = "22px";
        controlUI.style.textAlign = "center";
        controlUI.title = "Click to auto pan";
        controlDiv.appendChild(controlUI);
        // Set CSS for the control interior.
        controlText = document.createElement("div");
        controlText.style.color = "white";
        controlText.style.fontFamily = "Roboto,Arial,sans-serif";
        controlText.style.fontWeight = "bold";
        controlText.style.fontSize = "16px";
        controlText.style.lineHeight = "38px";
        controlText.style.paddingLeft = "5px";
        controlText.style.paddingRight = "5px";
        controlText.innerHTML = "Auto Pan";
        controlUI.appendChild(controlText);
        // Setup the click event listeners: simply set the map to Chicago.
        controlUI.addEventListener("click", () => {
            setAutoPan(!autoPan); // 反転
        });
    }

    function initMap() {
        map = new google.maps.Map(
            document.getElementById('map'),
            {
                center: new google.maps.LatLng(35.674874, 139.521906),
                zoom: 15,
                clickableIcons: false
            }
        );
        map.data.loadGeoJson(
            'featureCollection.json',
            null,
            (features) =>  {
                const feature = features[0];
                feature.getGeometry().forEachLatLng(function(latlng) {
                    latlngs.push(latlng);
                });
            }
        );
        map.data.setStyle({
            strokeColor: 'red'
        });
        map.data.addListener('click', function(event) {
            if (event.feature.getGeometry().getType() === 'LineString') {
                const latlng = event.latLng;
                var closest = latlngs.reduce(function(prev, curr) {
                    return (google.maps.geometry.spherical.computeDistanceBetween(latlng, curr) < google.maps.geometry.spherical.computeDistanceBetween(latlng, prev) ? curr : prev);
                });
                const index = latlngs.indexOf(closest);
                const time = times[index];
                player.seekTo(time, true);
                player.playVideo();
                setAutoPan(true);
            }
        });

        marker = new google.maps.Marker({
            position: map.getCenter(),
            map: map,
            clickable: false,
            icon: {
                url: 'cross.svg',
                scaledSize: new google.maps.Size(96, 96),
                anchor: new google.maps.Point(48, 48)
            }
        });

        map.addListener('drag', () => {
            // pauseVideo();
            setAutoPan(false);
        });

        // map.addListener('idle', function () {
        //     setLocation();
        // });
        setInterval(() => {
            setLocation();
        }, 1000);

        $.ajax({
            url: "time.json",
            dataType: "json",
            success: function( result ) {
                times = result;
            }
        });

        const panControlDiv = document.createElement("div");
        PanControl(panControlDiv, map);
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(panControlDiv);
    }

    window.onresize = () => {
        resize();
    }

    function setLocation() {
        if (player === null || player.getDuration() === 0) return;
        const currentTime = player.getCurrentTime();
        // const duration = player.getDuration();
        // const index = Math.floor(latlngs.length * (currentTime / duration));
        let intSec = Math.floor(currentTime);
        let index = times.indexOf(intSec);
        while (index === -1) {
            intSec--;
            if (intSec < 0) break;
            index = times.indexOf(intSec);
        }
        if (index === -1) return;
        const latlng = latlngs[index];
        // console.log(latlng.toJSON());
        if (autoPan) {
            map.panTo(latlng);
        }
        if (marker != null) {
            marker.setPosition(latlng);
        }
    }

    function resize() {
        const playerDiv = document.getElementById('movie');
        let width;
        let height;
        const mapDiv = document.getElementById('map');
        if (window.matchMedia('(orientation: landscape)').matches) {
            // landscape
            width = playerDiv.offsetWidth;
            height = playerHeight * (width / playerWidth);
            const offsetWidth = document.body.offsetWidth - width;
            $('#map').css('width', offsetWidth + 'px');
            $('#map').css('height', '');
        } else {
            // portrait
            height = playerDiv.offsetHeight;
            width = playerWidth * (height / playerHeight);
            const clientWidth = document.body.clientWidth;
            if (width > clientWidth) width = clientWidth;
            const offsetHeight = document.body.offsetHeight - height;
            $('#map').css('height', offsetHeight + 'px');
            $('#map').css('width', '');
        }
        if (player !== null) {
            player.setSize(width, height);
        }
        
        google.maps.event.trigger(map, "resize");
    }
</script>

</body>
</html>
