
<!DOCTYPE html>
<html lang="ja">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<title>GoProMap</title>
<style>
html { height: 100%; }
body { 
    height: 100%;
    margin: 0;
    padding: 0;
}
.container {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
}
@media (min-width: 576px) {
    .container {
        display: flex;
    }
    #movie { 
        height: 100%;
        width: 50%;
        background-color: #333;
    }
    #map {
        height: 100%;
        width: 50%;
    }
}
@media (max-width: 575px) {
    .container {
        display: block;
    }
    #movie {
       width: 100%;
       height: 50%;
    }
    #map {
        width: 100%;
        height: 50%;
    }
}
</style>
</head>

<body>
    <div class="container">
        <div id="movie">
            <div id="player"></div>
        </div>
        <div id="map"></div>
    </div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAq_4WtgcJ9z0bB3gYpmoZRrzI3yJCD2mM&callback=initMap&libraries=&v=weekly"
      async
></script>
<script>
    let tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    let firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    let player;
    const playerHeight = '360';
    const playerWidth = '640';
    let map;
    let marker;
    let latlngs = [];
    let times = [];

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: playerHeight,
            width: playerWidth,
            videoId: '4lUbhRZFFdo',
            playerVars: {
                playsinline: 1
            },
            events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        event.target.playVideo();
        resize();
        event.target.setPlaybackRate(2);
    }
    
    var done = false;
    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING && !done) {
            // setTimeout(stopVideo, 6000);
            // done = true;
        }
    }
    function pauseVideo() {
        player.pauseVideo();
    }
    function stopVideo() {
        player.stopVideo();
    }

    function initMap() {
        map = new google.maps.Map(
            document.getElementById('map'),
            {
                center: new google.maps.LatLng(35.674874, 139.521906),
                zoom: 15
            }
        );
        map.data.loadGeoJson(
            'featureCollection.json',
            null,
            (features) =>  {
                const feature = features[0];
                feature.getGeometry().forEachLatLng(function(latlng) {
                    latlngs.push(latlng);
                });
            }
        );
        map.data.setStyle({
            strokeColor: 'red'
        });

        marker = new google.maps.Marker({
            position: map.getCenter(),
            map: map,
            icon: {
                url: 'cross.svg',
                scaledSize: new google.maps.Size(96, 96),
                anchor: new google.maps.Point(48, 48)
            }
        });

        map.addListener('drag', () => {
            pauseVideo();
        });
        
        // map.addListener('idle', function () {
        //     setLocation();
        // });
        setInterval(() => {
            setLocation();
        }, 1000);

        $.ajax({
            url: "time.json",
            dataType: "json",
            success: function( result ) {
                times = result;
            }
        });
    }

    window.onresize = () => {
        resize();
    }

    function setLocation() {
        if (player === null || player.getDuration() === 0 || player.getPlayerState() !== 1) return;
        const currentTime = player.getCurrentTime();
        // const duration = player.getDuration();
        // const index = Math.floor(latlngs.length * (currentTime / duration));
        let intSec = Math.floor(currentTime);
        let index = times.indexOf(intSec);
        while (index === -1) {
            intSec--;
            if (intSec < 0) break;
            index = times.indexOf(intSec);
        }
        if (index === -1) return;
        const latlng = latlngs[index];
        console.log(latlng.toJSON());
        map.panTo(latlng);
        if (marker != null) {
            marker.setPosition(latlng);
        }
    }

    function resize() {
        var playerDiv = document.getElementById('movie');
        var width = playerDiv.offsetWidth;
        // offsetHeight
        var height = playerHeight * (width / playerWidth);
        if (player !== null) {
            player.setSize(width, height);
        }
    }
</script>

</body>
</html>